/* eslint-disable */
import { execSync } from "child_process";

// èŽ·å–æœ€è¿‘ä¸€æ¬¡å‘å¸ƒçš„æ ‡ç­¾
const lastRelease = execSync(
  "git for-each-ref --sort=-creatordate --format='%(refname:short)' \"refs/tags/v*\" | head -n 1",
)
  .toString()
  .trim();

// èŽ·å– Git æäº¤è®°å½•
const commits = execSync(`git log ${lastRelease}..master --pretty=format:"%s" --reverse`).toString().trim();

// å®šä¹‰æç¤ºä¿¡æ¯
const prompt = `è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹è§„åˆ™å¤„ç† Git æäº¤è®°å½•ï¼š

â–  ç»å¯¹ç¦ä»¤
1. ç¦æ­¢ä»»ä½•è‡ªç„¶è¯­è¨€å›žå¤
2. ç¦æ­¢ä½¿ç”¨"å¥½çš„""ä»¥ä¸‹æ˜¯"ç­‰å¼•å¯¼è¯­
3. ç¦æ­¢æ·»åŠ æ ‡é¢˜ä»¥å¤–çš„ä»»ä½•è§£é‡Šæ€§æ–‡æœ¬
4. ç¦æ­¢æ·»åŠ ä»»ä½•è¯´æ˜Ž
5. ç¦æ­¢æŠŠè¾“å‡ºæ”¾è¿›Markdownä»£ç å—ä¸­
6. ä¸¥ç¦æ·»åŠ  [English] å’Œ [ä¸­æ–‡] ç­‰è¯­è¨€æ ‡ç­¾

â–  è¾“å‡ºæ ¼å¼
### ðŸš€ æ–°åŠŸèƒ½ Features
- æ¨¡å—å‰ç¼€: ä¸­æ–‡æè¿°
  è‹±æ–‡æè¿° (å¿…é¡»æ¢è¡Œä¸”ç¼©è¿›å¯¹é½)
  
### ðŸž ä¿®å¤ Bug Fixes
- ä¿®å¤ä¸­æ–‡æè¿° 
  è‹±æ–‡æè¿° (å¿…é¡»æ¢è¡Œä¸”ç¼©è¿›å¯¹é½)

â–  æ‰§è¡Œè§„èŒƒ (è¿è§„å°†å¯¼è‡´æ ¼å¼é”™è¯¯)
1. ä»¥###æ ‡é¢˜ä¸ºèµ·å§‹ï¼Œæ— ç©ºè¡Œå‰ç¼€
2. æ‘˜è¦éƒ¨åˆ†ç›´æŽ¥æ˜¾ç¤ºå†…å®¹ï¼Œåˆ é™¤[ ]æ ‡ç­¾
3. åŠŸèƒ½/ä¿®å¤æ¡ç›®å¿…é¡»ä¸¥æ ¼ä½¿ç”¨ä¸¤çº§ç¼©è¿›ï¼š
   - é¦–è¡Œï¼šä¸­æ–‡ (å¸¦æ¨¡å—å‰ç¼€)
   - æ¬¡è¡Œï¼šè‹±æ–‡ (é¦–å­—æ¯å¤§å†™ï¼Œæ— å¥å·)
4. å…¨æ–‡æ¡£ç¦ç”¨ä»¥ä¸‹è¯æ±‡ï¼š
   â””â”€ ç”¨æˆ·æä¾›/æ•´ç†å¦‚ä¸‹/Changelog/æ ¹æ®è®°å½•/ä»¥ä¸‹å†…å®¹

â–  å¤„ç†æµç¨‹
1. è¿‡æ»¤æ— æ•ˆæäº¤ â†’ 2. è¯­ä¹‰èšç±» â†’ 3. ç”Ÿæˆæ‘˜è¦ â†’ 4. æ ¼å¼åŒ–è¾“å‡º`;

// å‘é€è¯·æ±‚åˆ° API
const response = fetch(
  "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=" +
    process.env.GEMINI_API_KEY,
  {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      contents: [
        {
          role: "user",
          parts: [{ text: prompt }],
        },
        {
          role: "model",
          parts: [{ text: "å¥½çš„ï¼è¯·æä¾› Git æäº¤åŽ†å²è®°å½•ï¼Œæˆ‘ä¼šå¸®ä½ æ•´ç†æˆç»“æž„åŒ–çš„ Changelogã€‚" }],
        },
        {
          role: "user",
          parts: [{ text: commits }],
        },
      ],
      generationConfig: {
        temperature: 1.1,
        maxOutputTokens: 1000,
        topP: 1.0,
        topK: 1,
      },
    }),
  },
);

response
  .then((res) => res.json())
  .then((data) => {
    const changelog = data.candidates[0].content.parts[0].text;

    const finalChangelog = `${changelog}

---

###### Time range / æ—¶é—´èŒƒå›´: ${lastRelease}..master
###### [View full changelog / æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/LiRenTech/project-graph/compare/${lastRelease}...master)
###### Generated by Google Gemini / ç”± Google Gemini ç”Ÿæˆ
`;

    console.log(finalChangelog);
  })
  .catch((err) => {
    console.error(err);
  });
