#!/bin/env bash

last_release=$(git for-each-ref --sort=-creatordate --format='%(refname:short)' "refs/tags/v*" | head -n 1)
commits=$(git log $last_release..master --pretty=format:"%an %s" --reverse)
commits_doubleslash=$(echo -n "$commits" | awk '{printf "%s\\n", $0}')

prompt="è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹è§„åˆ™å¤„ç† Git æäº¤è®°å½•ï¼š

â–  ç»å¯¹ç¦ä»¤
1. ç¦æ­¢ä»»ä½•è‡ªç„¶è¯­è¨€å›å¤
2. ç¦æ­¢ä½¿ç”¨"å¥½çš„""ä»¥ä¸‹æ˜¯"ç­‰å¼•å¯¼è¯­
3. ç¦æ­¢æ·»åŠ æ ‡é¢˜ä»¥å¤–çš„ä»»ä½•è§£é‡Šæ€§æ–‡æœ¬
4. ç¦æ­¢æ·»åŠ ä»»ä½•è¯´æ˜
5. ç¦æ­¢æŠŠè¾“å‡ºæ”¾è¿›Markdownä»£ç å—ä¸­
6. ä¸¥ç¦æ·»åŠ  [English] å’Œ [ä¸­æ–‡] ç­‰è¯­è¨€æ ‡ç­¾

â–  è¾“å‡ºæ ¼å¼
### ğŸ“– æ‘˜è¦ Summary
[æ— ä»»ä½•å‰ç¼€çš„è‹±æ–‡æ‘˜è¦]
[å¯¹åº”ä¸­æ–‡æ‘˜è¦]

### ğŸš€ æ–°åŠŸèƒ½ Features
- æ¨¡å—å‰ç¼€: ä¸­æ–‡æè¿°
  è‹±æ–‡æè¿° (å¿…é¡»æ¢è¡Œä¸”ç¼©è¿›å¯¹é½)
  
### ğŸ ä¿®å¤ Bug Fixes
- ä¿®å¤ä¸­æ–‡æè¿° 
  è‹±æ–‡æè¿° (å¿…é¡»æ¢è¡Œä¸”ç¼©è¿›å¯¹é½)

â–  æ‰§è¡Œè§„èŒƒ (è¿è§„å°†å¯¼è‡´æ ¼å¼é”™è¯¯)
1. ä»¥###æ ‡é¢˜ä¸ºèµ·å§‹ï¼Œæ— ç©ºè¡Œå‰ç¼€
2. æ‘˜è¦éƒ¨åˆ†ç›´æ¥æ˜¾ç¤ºå†…å®¹ï¼Œåˆ é™¤[ ]æ ‡ç­¾
3. åŠŸèƒ½/ä¿®å¤æ¡ç›®å¿…é¡»ä¸¥æ ¼ä½¿ç”¨ä¸¤çº§ç¼©è¿›ï¼š
   - é¦–è¡Œï¼šä¸­æ–‡ (å¸¦æ¨¡å—å‰ç¼€)
   - æ¬¡è¡Œï¼šè‹±æ–‡ (é¦–å­—æ¯å¤§å†™ï¼Œæ— å¥å·)
4. å…¨æ–‡æ¡£ç¦ç”¨ä»¥ä¸‹è¯æ±‡ï¼š
   â””â”€ ç”¨æˆ·æä¾›/æ•´ç†å¦‚ä¸‹/Changelog/æ ¹æ®è®°å½•/ä»¥ä¸‹å†…å®¹

â–  å¤„ç†æµç¨‹
1. è¿‡æ»¤æ— æ•ˆæäº¤ â†’ 2. è¯­ä¹‰èšç±» â†’ 3. ç”Ÿæˆæ‘˜è¦ â†’ 4. æ ¼å¼åŒ–è¾“å‡º"
prompt_doubleslash=$(echo -n "$prompt" | awk '{printf "%s\\n", $0}')

changelog=$(curl "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=$GEMINI_API_KEY" \
  -s \
  -H 'Content-Type: application/json' \
  -X POST \
  -d "{
    \"contents\": [
      {
        \"role\": \"user\",
        \"parts\": [{
          \"text\": \"è¯·å°†ç”¨æˆ·æä¾›çš„ Git æäº¤å†å²è®°å½•æŒ‰ä»¥ä¸‹ç»“æ„åŒ–æ ¼å¼æ•´ç†ï¼š\n\n### ğŸ“– Summary æ‘˜è¦\n[è‹±æ–‡ç‰ˆ] \nç”¨1-2å¥ç®€æ˜è‹±æ–‡æ¦‚æ‹¬æœ¬æ¬¡æ›´æ–°çš„æ ¸å¿ƒå†…å®¹ï¼Œçªå‡ºä¸»è¦æ”¹è¿›æ–¹å‘\n\n[ä¸­æ–‡ç‰ˆ]\nç”¨æµç•…è‡ªç„¶çš„ä¸­æ–‡å¤è¿°è‹±æ–‡æ‘˜è¦ï¼Œä¿æŒä¸“ä¸šæŠ€æœ¯æ–‡æ¡£è¯­æ°”\n\n### ğŸš€ Features æ–°åŠŸèƒ½\n- ä½¿ç”¨å°æ ‡é¢˜+å†’å·æ ¼å¼æå–åŠŸèƒ½é¡¹ (ä¾‹: Auth: æ–°å¢ç¬¬ä¸‰æ–¹ç™»å½•æ”¯æŒ)\n- æ¯æ¡åŠŸèƒ½æè¿°éœ€ä¸­è‹±åŒè¯­å¯¹ç…§\n- ä¼˜å…ˆå±•ç¤ºå½±å“è¾ƒå¤§çš„åŠŸèƒ½\n- ç›¸åŒæ¨¡å—çš„åŠŸèƒ½åˆå¹¶å±•ç¤º\n\n### ğŸ Bug Fixes ä¿®å¤\n- ç”¨\\"ä¿®å¤XXé—®é¢˜\\"ä½œä¸ºæ ‡å‡†å¼€å¤´\n- åŒ…å«é—®é¢˜ç°è±¡å’Œå½±å“èŒƒå›´è¯´æ˜ (ä¾‹: ä¿®å¤å†…å­˜æ³„æ¼å¯¼è‡´æœåŠ¡å´©æºƒçš„é—®é¢˜)\n- æŠ€æœ¯ç»†èŠ‚ä½¿ç”¨ä¸­æ–‡æè¿°\n- æŒ‰é—®é¢˜ä¸¥é‡æ€§æ’åº\n\nå¤„ç†è¦æ±‚ï¼š\n1. è‡ªåŠ¨è¿‡æ»¤Merge branch/update versionç­‰æ— æ„ä¹‰æäº¤\n2. å¯¹ç›¸ä¼¼æäº¤è¿›è¡Œæ™ºèƒ½åˆå¹¶\n3. ä¸­è‹±æ–‡å†…å®¹éœ€ä¿æŒä¸¥æ ¼å¯¹åº”\n4. ä½¿ç”¨æŠ€æœ¯æœ¯è¯­ä¿æŒå‡†ç¡®\n5. è¾“å‡ºä½¿ç”¨GitHubé£æ ¼çš„Markdownæ ¼å¼\"
        }]
      },
      {
        \"role\": \"model\",
        \"parts\": [{
          \"text\": \"å¥½çš„ï¼è¯·æä¾› Git æäº¤å†å²è®°å½•ï¼Œæˆ‘ä¼šå¸®ä½ æ•´ç†æˆç»“æ„åŒ–çš„ Changelogã€‚\"
        }]
      },
      {
        \"role\": \"user\",
        \"parts\": [{
          \"text\": \"$commits_doubleslash\"
        }]
      }
    ],
    \"generationConfig\": {
      \"temperature\": 1.1,
      \"maxOutputTokens\": 1000,
      \"topP\": 1.0,
      \"topK\": 1
    }
  }" |
  jq -r '.candidates[0].content.parts[0].text' |
  sed -n '/### ğŸ“–/,$p')

changelog="$changelog

---

###### Time range / æ—¶é—´èŒƒå›´: $last_release..master
###### [View full changelog / æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/LiRenTech/project-graph/compare/$last_release...master)
###### Generated by Google Gemini / ç”± Google Gemini ç”Ÿæˆ
"

echo "$changelog"
